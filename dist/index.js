#!/usr/bin/env node
"use strict";var inquirer=require("inquirer"),fs=require("fs"),path=require("path"),superagent=require("superagent"),download=require("download-git-repo"),zip=require("adm-zip"),ora=require("ora"),commander=require("commander");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var inquirer__default=_interopDefaultLegacy(inquirer),fs__default=_interopDefaultLegacy(fs),path__default=_interopDefaultLegacy(path),superagent__default=_interopDefaultLegacy(superagent),download__default=_interopDefaultLegacy(download),zip__default=_interopDefaultLegacy(zip),ora__default=_interopDefaultLegacy(ora),RepositoryList={h5vue3:"direct:https://github.com/Roxinn1996/vue3Ts/archive/refs/heads/master.zip",test_admin:"direct:https://github.com/Roxinn1996/test_admin/archive/refs/heads/master.zip"};const IS_PRODUCTION="production"===process.env.NODE_ENV,DEV_LAYER=IS_PRODUCTION?__dirname:path__default.default.resolve(__dirname,"..",".."),SAVE_PATH=path__default.default.resolve(DEV_LAYER,"local"),FILE_NAME="repository.json",SAVE_FILE_NAME=path__default.default.resolve(SAVE_PATH,FILE_NAME);function getRepositoryData(){return fs__default.default.existsSync(SAVE_FILE_NAME)?require(SAVE_FILE_NAME):{}}const PROMPT_LIST=[{type:"input",message:"enter your projectName",name:"projectName",default:"test"},{type:"list",message:"choose download template",name:"templateName",choices:Object.keys(Object.assign(RepositoryList,getRepositoryData(),{custom:""}))}],CUSTOM_TEMPLATE=[{type:"list",message:"choose your repository type",name:"repositoryType",choices:["public","private"]},{type:"input",when({repositoryType:e}){return"private"===e},name:"repositoryUser",message:"input your git username"},{type:"password",when({repositoryType:e}){return"private"===e},name:"repositoryPass",message:"input your git password"},{type:"input",message:"custom repository url",name:"repositoryUrl"}];async function privateClone(e,t,r,a,o=!0){a=`${o?"https://":"http://"}${t}:${r}@${a.replace(/^https?:\/\//,"")}`;try{var s=await superagent__default.default.get(a);if(!s.body||!Buffer.isBuffer(s.body))throw new Error("request data is not a buffer");return fs.existsSync(e)||fs.mkdirSync(e),unzipFile(e,s.body),!0}catch(e){return console.error(e),!1}}function unzipFile(a,e){const t=new zip__default.default(e),r=t.getEntries();let o="";r.forEach((e,t)=>{var r;e.isDirectory?0===t?o=e.entryName:(r=path__default.default.resolve(a,e.entryName.replace(o,"")),fs.existsSync(r)||fs.mkdirSync(r)):(r=path__default.default.resolve(a,e.entryName.replace(o,"")),fs.existsSync(r)||fs.writeFileSync(r,e.getData(),{encoding:"utf-8"}))})}function downloadTemplate(s){return new Promise(t=>{var e=process.cwd(),{projectName:r,templateName:a,repositoryUrl:o}=s,r=path__default.default.resolve(e,r),a=o?`direct:${o}`:RepositoryList[a];download__default.default(a,r,{},e=>{e&&(console.log(e),t(!1)),t(!0)})})}async function handlePromptMethod(t){const r=ora__default.default("start download template").start();try{var{repositoryType:a,projectName:o,repositoryUser:s="",repositoryPass:i="",repositoryUrl:n=""}=t;let e=!0;e="private"===a?await privateClone(path__default.default.resolve(process.cwd(),o),s,i,n):await downloadTemplate(t),e?r.succeed("download template success"):r.fail("download fail")}catch(e){console.log(e),r.fail("download fail")}}function createCommand(){const e=new commander.Command;return e.version("0.1.1"),e.addHelpText("after","test"),e.parse(process.argv),e}function entry(){inquirer__default.default.prompt(PROMPT_LIST).then(async e=>{var{templateName:t}=e;let r=e;"custom"===t&&(t=await inquirer__default.default.prompt(CUSTOM_TEMPLATE),r=Object.assign(r,t)),handlePromptMethod(r)})}createCommand(),entry();
